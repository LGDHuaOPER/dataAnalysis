function IsInnerRect(e,t){return t.x>e.x&&t.x<=e.x+e.width&&t.y>e.y&&t.y<=e.y+e.height}function getEventPosition(e){var t,i;return e.layerX||0==e.layerX?(t=e.layerX,i=e.layerY):(e.offsetX||0==e.offsetX)&&(t=e.offsetX,i=e.offsetY),{x:t,y:i}}function mapAddHighLight(e,t,i,o,r){e.strokeStyle="#FFA500",e.lineWidth=.06*o,e.beginPath();var a=.037*o;e.moveTo(t+o/5,i),e.lineTo(t,i),e.lineTo(t,i+r/5),e.moveTo(t,i+r/5*4),e.lineTo(t,i+r-a),e.lineTo(t+o/5,i+r-a),e.moveTo(t+o/5*4,i+r-a),e.lineTo(t+o-a,i+r-a),e.lineTo(t+o-a,i+r/5*4),e.moveTo(t+o/5*4,i),e.lineTo(t+o-a,i),e.lineTo(t+o-a,i+r/5),e.stroke()}function HashTable(){var i=0,o=new Object;this.add=function(e,t){this.containsKey(e)||i++,o[e]=t},this.getValue=function(e){return this.containsKey(e)?o[e]:null},this.remove=function(e){this.containsKey(e)&&delete o[e]&&i--},this.containsKey=function(e){return e in o},this.containsValue=function(e){for(var t in o)if(o[t]==e)return!0;return!1},this.getValues=function(){var e=new Array;for(var t in o)e.push(o[t]);return e},this.getKeys=function(){var e=new Array;for(var t in o)e.push(t);return e},this.getSize=function(){return i},this.clear=function(){i=0,o=new Object}}function changeHash(e){for(var t=new HashTable,i=0;i<e.length;i++)for(var o in e[i])t.add(o,e[i][o]);return t}function WaferMapPlotObj(e){this.colorMap=e.colorMap,this.bgFillColor=e.bgFillColor,this.ctx=e.ctx,this.r0=e.r0,this.r=e.r,this.centerX=e.centerX,this.centerY=e.centerY,this.dieX=e.dieX,this.dieY=e.dieY,this.minRow=e.minRow,this.maxRow=e.maxRow,this.minCol=e.minCol,this.maxCol=e.maxCol,this.coordsArray=e.coordsArray,this.positionFlag=e.positionFlag,this.FlatLength=e.FlatLength,this.colorOrder=e.colorOrder,this.filterArr=e.filterArr,this.currentDieCoord=e.currentDieCoord,this.isFirst=e.isFirst,this.isSaveDieCoord=e.isSaveDieCoord,this.saveDieCoord=e.saveDieCoord,this.coordsArra=e.coordsArra,this.vectorMap=e.vectorMap,this.container=e.container}function renderWaferMapByGetData(obj){var can=document.getElementById(obj.container),ctx=can.getContext("2d");can.width=obj.width,can.height=obj.height;var newWaferMap=new WaferMapPlotObj({colorMap:obj.colorMap,bgFillColor:obj.bgFillColor,ctx:ctx,r0:parseFloat(obj.waferData.Diameter||obj.waferData.diameter),r:obj.width/2-obj.spacePercent.x*obj.width,centerX:obj.width/2,centerY:obj.width/2-obj.spacePercent.x*obj.width+obj.spacePercent.y*obj.height,dieX:parseFloat(obj.waferData.DieSizeX||obj.waferData.dieSizeX),dieY:parseFloat(obj.waferData.DieSizeY||obj.waferData.dieSizeY),minRow:parseFloat(obj.waferData.minY),maxRow:parseFloat(obj.waferData.maxY),minCol:parseFloat(obj.waferData.minX),maxCol:parseFloat(obj.waferData.maxX),coordsArray:changeHash(obj.m_DieDataListNew),positionFlag:(obj.waferData.DirectionX||obj.waferData.directionX)+(obj.waferData.DirectionY||obj.waferData.directionY),FlatLength:parseFloat(obj.waferData.FlatLength||obj.waferData.flagLength),colorOrder:obj.colorOrder,filterArr:obj.filterArr,currentDieCoord:obj.currentDieCoord,isFirst:obj.isFirst,isSaveDieCoord:obj.isSaveDieCoord,saveDieCoord:obj.saveDieCoord,coordsArra:obj.coordsArra,vectorMap:obj.vectorMap,container:obj.container});if(newWaferMap.plot(),obj.addEvent&&($(can).off("mousemove click"),$(can).on({mousemove:function(e){e.stopPropagation(),obj.curSelectedDie=null;for(var t=eouluGlobal.S_getEventPosition(e),i=obj.waferData.maxY;i>=obj.waferData.minY;i--){for(var o=obj.waferData.maxX;o>=obj.waferData.minX;o--){var r=o+":"+i;if(obj.coordsArra.containsKey(r)){var a=obj.coordsArra.getValue(r);if(IsInnerRect(a.rect,t)){obj.curSelectedDie=_.cloneDeep(a),obj.curSelectedDie.x=o,obj.curSelectedDie.y=i;break}}}if(null!=obj.curSelectedDie)break}null!==obj.curSelectedDie?($("html, body").css("cursor","pointer"),$("#in").fadeIn(50),$("#in").html('<ul style="list-style:none;"><li>DIE信息</li><li>Coord: ('+obj.curSelectedDie.x+":"+obj.curSelectedDie.y+")</li><li>Bin:"+obj.curSelectedDie.Bin+"</li>"),$("#in").css({left:t.x+10+"px",top:t.y+10+"px",color:"#000",background:"#fff",padding:"5px"})):($("#in").fadeOut(50),$("html,body").css("cursor","default"))},click:function(e){e.stopPropagation(),obj.curSelectedDie=null;for(var t=eouluGlobal.S_getEventPosition(e),i=obj.waferData.maxY;i>=obj.waferData.minY;i--){for(var o=obj.waferData.minX;o<=obj.waferData.maxX;o++){var r=o+":"+i;if(obj.coordsArra.containsKey(r)){var a=obj.coordsArra.getValue(r);if(IsInnerRect(a.rect,t)){obj.curSelectedDie=_.cloneDeep(a),obj.curSelectedDie.x=o,obj.curSelectedDie.y=i;break}}}if(null!=obj.curSelectedDie)break}if(null!=obj.curSelectedDie&&"disabled"!=obj.curSelectedDie.filterFlag&&-1!=obj.curSelectedDie.Bin&&5001!=obj.curSelectedDie.Bin&&"-1"!=obj.curSelectedDie.Dieno){var l=obj.curSelectedDie.x+":"+obj.curSelectedDie.y;newWaferMap.setPlotParam({currentDieCoord:l}).plot(),obj.clickCallback&&obj.clickCallback(l)}}}),$(document).off("keydown"),$(document).on("keydown",function(e){e.stopPropagation();for(var code=e.keyCode||e.which||e.charCode,currentDie_x="",currentDie_y="",i=parseFloat(obj.waferData.maxY);i>=parseFloat(obj.waferData.minY);i--)for(var j=parseFloat(obj.waferData.minX);j<=parseFloat(obj.waferData.maxX);j++){var key=j+":"+i;if(obj.coordsArra.containsKey(key)){var die=obj.coordsArra.getValue(key);if(die.moveFlag){currentDie_x=j,currentDie_y=i;break}}}var positionFlag=obj.waferData.DirectionX+obj.waferData.DirectionY,Die_x=currentDie_x,Die_y=currentDie_y,len=obj.coordsArra.getKeys().length,codeMap={37:{vari:"x",Left:"-",Right:"+"},38:{vari:"y",Top:"-",Down:"+"},39:{vari:"x",Left:"+",Right:"-"},40:{vari:"y",Top:"+",Down:"-"}},codeItem=_.find(codeMap,function(e,t){return t==code});if(_.isNil(codeItem))return!1;for(var i=1;i<len;i++){var a="Die_"+codeItem.vari,b="currentDie_"+codeItem.vari,c=codeItem[eval("obj.waferData.Direction"+codeItem.vari.toUpperCase())]||codeItem[eval("obj.waferData.direction"+codeItem.vari.toUpperCase())];console.log(a),console.log(b),console.log(c);var ee=a+" = "+b+c+"i";eval(ee);var newkey=Die_x+":"+Die_y;if(obj.coordsArra.containsKey(newkey)){if(-1==obj.coordsArra.getValue(newkey).Bin||5001==obj.coordsArra.getValue(newkey).Bin||"disabled"==obj.coordsArra.getValue(newkey).filterFlag)continue;break}}if(-1<_.indexOf([37,38,39,40],code)){var newkey2=Die_x+":"+Die_y;obj.coordsArra.containsKey(newkey2)&&(newWaferMap.setPlotParam({currentDieCoord:newkey2}).plot(),obj.keydownCallback&&obj.keydownCallback(newkey2))}})),obj.returnFlag)return newWaferMap}function getGradientColor(e,t,i,o){var r=/#((?:[0-9]|[a-fA-F]){2})((?:[0-9]|[a-fA-F]){2})((?:[0-9]|[a-fA-F]){2})/,a=e.match(r),l=t.match(r),n="";if(i=i||1,o=o||0,null===a&&(n="start"),null===l&&(n="end"),0<n.length)throw new Error("Invalid "+n+" color format, required hex color");var c=parseInt(a[1],16),s=parseInt(a[2],16),d=parseInt(a[3],16),f=parseInt(l[1],16),h=parseInt(l[2],16),b=parseInt(l[3],16),u=o/i,g=Math.round(c+(f-c)*u).toString(16),D=Math.round(s+(h-s)*u).toString(16),m=Math.round(d+(b-d)*u).toString(16);return"#"+(g=eouluGlobal.S_getLastStr("0"+g,2))+(D=eouluGlobal.S_getLastStr("0"+D,2))+(m=eouluGlobal.S_getLastStr("0"+m,2))}function buildColorGradation(t){var i=new HashTable,e=t.colorOrder;if(!0===e){var o=t.theMin,r=t.lowwer,a=t.midder,l=t.upper,n=t.theMax,c=t.colorGradation.twoDiff,s=t.colorGradation.threeDiff,d=t.colorGradation.fourDiff,f=t.colorGradation.fiveDiff;_.times(c,function(e){i.add("2:"+(o+e),getGradientColor(t.colorGradation.lowwerColor,t.colorGradation.theMinColor,t.colorGradation.twoDiff,t.colorGradation.twoDiff-e))}),_.times(s,function(e){i.add("3:"+(r+e),getGradientColor(t.colorGradation.midderColor,t.colorGradation.lowwerColor,t.colorGradation.threeDiff,t.colorGradation.threeDiff-e))}),_.times(d,function(e){i.add("4:"+(a+e),getGradientColor(t.colorGradation.upperColor,t.colorGradation.midderColor,t.colorGradation.fourDiff,t.colorGradation.fourDiff-e))}),_.times(f,function(e){i.add("5:"+(l+e),getGradientColor(t.colorGradation.theMaxColor,t.colorGradation.upperColor,t.colorGradation.fiveDiff,t.colorGradation.fiveDiff-e))}),i.add("1:"+o,t.colorGradation.theMinColor),i.add("6:"+n,t.colorGradation.theMaxColor),_.forOwn(t.otherColor,function(e,t){i.add(t,e)})}else i.add(-123456,t.colorGradation.limitColor),i.add(123456,t.colorGradation.limitColor),_.times(256,function(e){0<e&&i.add(e,getGradientColor(t.colorGradation.limitColor,t.colorGradation.floorColor,t.colorGradation.nums,t.colorGradation.nums-e))}),i.add(-1,"#314067"),i.add(5001,"#FFFFFF"),i.add(5e3,"#FDFDFD");var h=t.width,b=t.height;t.custom&&(!0===t.custom.WH&&(h=50*(t.waferData.maxX-t.waferData.minX+1),b=50*(t.waferData.maxY-t.waferData.minY+1)),(h>t.maxWidth||b>t.maxHeight)&&(h=b=_.sortBy([t.maxHeight,t.maxWidth])[0]));var u=renderWaferMapByGetData({width:h,height:b,container:t.container,bgFillColor:t.bgFillColor,colorMap:i,waferData:t.waferData,spacePercent:t.spacePercent,m_DieDataListNew:t.m_DieDataListNew,colorOrder:e,filterArr:t.filterArr,currentDieCoord:t.currentDieCoord,isFirst:t.isFirst,isSaveDieCoord:t.isSaveDieCoord,saveDieCoord:t.saveDieCoord,coordsArra:t.coordsArra,returnFlag:t.returnFlag,addEvent:t.addEvent,curSelectedDie:t.curSelectedDie,vectorMap:t.vectorMap,clickCallback:t.clickCallback,keydownCallback:t.keydownCallback}),g=(t.waferData.DirectionX||t.waferData.directionX)+(t.waferData.DirectionY||t.waferData.directionY);if(t.callback&&t.callback(g,u),t.resizeCallback&&t.resizeCallback(h,b,u),t.returnFlag)return u}null==WaferMapPlotObj.prototype.type&&(WaferMapPlotObj.prototype.setPlotParam=function(e){return _.isEmpty(e)||_.forOwn(e,function(e,t){this[t]=e}.bind(this)),this},WaferMapPlotObj.prototype.plot=function(){for(var e=this.colorMap,t=this.ctx,i=this.bgFillColor,o=.001*this.r*this.dieX/this.r0,r=.001*this.r*this.dieY/this.r0,a=this.r,l=-999999,n=999999,c=-999999,s=999999,d=this.colorOrder,f=this.filterArr,h=this.isFirst,b=this.isSaveDieCoord,u=this.coordsArra,g=this.vectorMap,D=this.maxRow;D>=this.minRow;D--)for(var m=this.maxCol;m>=this.minCol;m--){var y=m+":"+D;this.coordsArray.containsKey(y)&&(l<m&&(l=m),m<n&&(n=m),c<D&&(c=D),D<s&&(s=D),s==c&&(s-=1),l==n&&(n-=1))}var w=(l+n)/2,p=(c+s)/2;r=o*(l-n)/(c-s);var j=0,v=0;for(D=this.maxRow;D>=this.minRow;D--)for(m=this.maxCol;m>=this.minCol;m--){y=m+":"+D;this.coordsArray.containsKey(y)&&j<(v=Math.sqrt(Math.pow((Math.abs(m-w)+.5)*o,2)+Math.pow((Math.abs(D-p)+.5)*r,2)))&&(j=v)}o=.995*o*a/j,r=.995*r*a/j;var F=Math.floor(180*Math.asin(this.FlatLength/(2*this.r0))/Math.PI),C=(90+F)*Math.PI/180,x=(90-F)*Math.PI/180;t.fillStyle=i,t.beginPath(),C==x?t.arc(this.centerX,this.centerY,this.r,0,2*Math.PI):t.arc(this.centerX,this.centerY,this.r,C,x),t.closePath(),t.fill();this.r,this.r;var S=0;if("nullnull"==this.positionFlag)for(D=this.maxRow;D>=this.minRow;D--){var k=this.centerY+D*r-r;for(m=this.maxCol;m>=this.minCol;m--){y=m+":"+D;var A=this.centerX-m*o;if(this.coordsArray.containsKey(y)){S++;var M=this.coordsArray.getValue(y),G=new Object,O=new Object;if(!0===d?(t.fillStyle=e.getValue(M.color),g&&(_.isEmpty(f)?G.filterFlag="undisabled":-1<_.indexOf(f,y)&&-1!=M.bin?G.filterFlag="undisabled":(t.fillStyle="#ccc",G.filterFlag="disabled"))):(t.fillStyle=e.getValue(M),g&&(_.isEmpty(f)?G.filterFlag="undisabled":-1<_.indexOf(f,y)&&-1!=M?G.filterFlag="undisabled":(t.fillStyle="#ccc",G.filterFlag="disabled"))),t.fillRect(A,k,o,r),t.lineWidth=1,t.strokeStyle="black",t.strokeRect(A,k,o,r),g){var R=M;!0===d&&(R=M.bin),_.isEmpty(this.currentDieCoord)&&h&&"undisabled"==G.filterFlag&&-1!=R&&5001!=R?(mapAddHighLight(t,A,k,o,r),h=!1,(G.moveFlag=!0)===b&&(this.saveDieCoord[0]=y)):this.currentDieCoord==y?(mapAddHighLight(t,A,k,o,r),G.moveFlag=!0):G.moveFlag=!1,O.x=A,O.y=k,O.width=o,O.height=r,G.Dieno=S,G.Bin=R,G.rect=O,u.add(y,G)}}else t.fillStyle="#20242b"}}else if("LeftDown"==this.positionFlag)for(D=this.minRow;D<=this.maxRow;D++)for(k=this.centerY-D*r+p*r-.5*r,m=this.minCol;m<=this.maxCol;m++){y=m+":"+D,A=this.centerX+m*o-w*o-.5*o;if(this.coordsArray.containsKey(y)){S++;M=this.coordsArray.getValue(y),G=new Object,O=new Object;if(!0===d?(t.fillStyle=e.getValue(M.color),g&&(_.isEmpty(f)?G.filterFlag="undisabled":-1<_.indexOf(f,y)&&-1!=M.bin?G.filterFlag="undisabled":(t.fillStyle="#ccc",G.filterFlag="disabled"))):(t.fillStyle=e.getValue(M),g&&(_.isEmpty(f)?G.filterFlag="undisabled":-1<_.indexOf(f,y)&&-1!=M?G.filterFlag="undisabled":(t.fillStyle="#ccc",G.filterFlag="disabled"))),t.fillRect(A,k,o,r),t.lineWidth=1,t.strokeStyle="black",t.strokeRect(A,k,o,r),g){R=M;!0===d&&(R=M.bin),_.isEmpty(this.currentDieCoord)&&h&&"undisabled"==G.filterFlag&&-1!=R&&5001!=R?(mapAddHighLight(t,A,k,o,r),h=!1,(G.moveFlag=!0)===b&&(this.saveDieCoord[0]=y)):this.currentDieCoord==y?(mapAddHighLight(t,A,k,o,r),G.moveFlag=!0):G.moveFlag=!1,O.x=A,O.y=k,O.width=o,O.height=r,G.Dieno=S,G.Bin=R,G.rect=O,u.add(y,G)}}else t.fillStyle="#20242b"}else if("RightDown"==this.positionFlag)for(D=this.maxRow;D>=this.minRow;D--)for(k=this.centerY-D*r+p*r-.5*r,m=this.maxCol;m>=this.minCol;m--){y=m+":"+D,A=this.centerX-m*o+w*o-.5*o;if(this.coordsArray.containsKey(y)){S++;M=this.coordsArray.getValue(y),G=new Object,O=new Object;if(!0===d?(t.fillStyle=e.getValue(M.color),g&&(_.isEmpty(f)?G.filterFlag="undisabled":-1<_.indexOf(f,y)&&-1!=M.bin?G.filterFlag="undisabled":(t.fillStyle="#ccc",G.filterFlag="disabled"))):(t.fillStyle=e.getValue(M),g&&(_.isEmpty(f)?G.filterFlag="undisabled":-1<_.indexOf(f,y)&&-1!=M?G.filterFlag="undisabled":(t.fillStyle="#ccc",G.filterFlag="disabled"))),t.fillRect(A,k,o,r),t.lineWidth=1,t.strokeStyle="black",t.strokeRect(A,k,o,r),g){R=M;!0===d&&(R=M.bin),_.isEmpty(this.currentDieCoord)&&h&&"undisabled"==G.filterFlag&&-1!=R&&5001!=R?(mapAddHighLight(t,A,k,o,r),h=!1,(G.moveFlag=!0)===b&&(this.saveDieCoord[0]=y)):this.currentDieCoord==y?(mapAddHighLight(t,A,k,o,r),G.moveFlag=!0):G.moveFlag=!1,O.x=A,O.y=k,O.width=o,O.height=r,G.Dieno=S,G.Bin=R,G.rect=O,u.add(y,G)}}else t.fillStyle="#20242b"}else if("RightTop"==this.positionFlag)for(D=this.minRow;D<=this.maxRow;D++)for(k=this.centerY+D*r-p*r-.5*r,m=this.maxCol;m>=this.minCol;m--){y=m+":"+D,A=this.centerX-m*o+w*o-.5*o;if(this.coordsArray.containsKey(y)){S++;M=this.coordsArray.getValue(y),G=new Object,O=new Object;if(!0===d?(t.fillStyle=e.getValue(M.color),g&&(_.isEmpty(f)?G.filterFlag="undisabled":-1<_.indexOf(f,y)&&-1!=M.bin?G.filterFlag="undisabled":(t.fillStyle="#ccc",G.filterFlag="disabled"))):(t.fillStyle=e.getValue(M),g&&(_.isEmpty(f)?G.filterFlag="undisabled":-1<_.indexOf(f,y)&&-1!=M?G.filterFlag="undisabled":(t.fillStyle="#ccc",G.filterFlag="disabled"))),t.fillRect(A,k,o,r),t.lineWidth=1,t.strokeStyle="black",t.strokeRect(A,k,o,r),g){R=M;!0===d&&(R=M.bin),_.isEmpty(this.currentDieCoord)&&h&&"undisabled"==G.filterFlag&&-1!=R&&5001!=R?(mapAddHighLight(t,A,k,o,r),h=!1,(G.moveFlag=!0)===b&&(this.saveDieCoord[0]=y)):this.currentDieCoord==y?(mapAddHighLight(t,A,k,o,r),G.moveFlag=!0):G.moveFlag=!1,O.x=A,O.y=k,O.width=o,O.height=r,G.Dieno=S,G.Bin=R,G.rect=O,u.add(y,G)}}else t.fillStyle="#20242b"}else if("LeftTop"==this.positionFlag)for(D=this.minRow;D<=this.maxRow;D++)for(k=this.centerY+D*r-p*r-.5*r,m=this.minCol;m<=this.maxCol;m++){y=m+":"+D,A=this.centerX+m*o-w*o-.5*o;if(this.coordsArray.containsKey(y)){S++;M=this.coordsArray.getValue(y),G=new Object,O=new Object;if(!0===d?(t.fillStyle=e.getValue(M.color),g&&(_.isEmpty(f)?G.filterFlag="undisabled":-1<_.indexOf(f,y)&&-1!=M.bin?G.filterFlag="undisabled":(t.fillStyle="#ccc",G.filterFlag="disabled"))):(t.fillStyle=e.getValue(M),g&&(_.isEmpty(f)?G.filterFlag="undisabled":-1<_.indexOf(f,y)&&-1!=M?G.filterFlag="undisabled":(t.fillStyle="#ccc",G.filterFlag="disabled"))),t.fillRect(A,k,o,r),t.lineWidth=1,t.strokeStyle="black",t.strokeRect(A,k,o,r),g){R=M;!0===d&&(R=M.bin),_.isEmpty(this.currentDieCoord)&&h&&"undisabled"==G.filterFlag&&-1!=R&&5001!=R?(mapAddHighLight(t,A,k,o,r),h=!1,(G.moveFlag=!0)===b&&(this.saveDieCoord[0]=y)):this.currentDieCoord==y?(mapAddHighLight(t,A,k,o,r),G.moveFlag=!0):G.moveFlag=!1,O.x=A,O.y=k,O.width=o,O.height=r,G.Dieno=S,G.Bin=R,G.rect=O,u.add(y,G)}}else t.fillStyle="#20242b"}});